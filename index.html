
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AOTA Student Pulse Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for browser-side TSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@1.3.0",
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>
    
    <script>
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- App Logic -->
    <script type="text/babel" data-type="module">
      import { GoogleGenAI, Type } from "@google/genai";
      const { useState, useEffect, useRef } = React;

      // --- Constants ---
      const SYSTEM_INSTRUCTION = `
        You are the Senior Editor for the American Occupational Therapy Association (AOTA) "Student Pulse" e-newsletter. 
        Your goal is to mentor OT and OTA students to refine their articles for publication.
        Evaluate the draft against:
        1. Tone: Authentic, conversational, peer-to-peer.
        2. Format: Bulleted/numbered lists, headings, no walls of text.
        3. Structure: Strong thesis, supporting points.
        4. Packaging: Catchy title.
        5. Length: Max 750 words.
        6. Admin: Must have signed copyright form.

        Disclaimer: "Please note: Articles are not guaranteed to be published based on a pitch or a first draft."

        Output JSON. Bold edits with **text**. Use person-first language.
      `;

      // --- Components ---
      const CheckIcon = ({ checked }) => (
        <span className={`mr-2 flex-shrink-0 w-6 h-6 flex items-center justify-center rounded border ${checked ? 'bg-green-100 border-green-500 text-green-700' : 'bg-gray-100 border-gray-300 text-gray-400'}`}>
          {checked ? <i className="fas fa-check text-xs"></i> : <i className="fas fa-times text-xs"></i>}
        </span>
      );

      const Scorecard = ({ scorecard, rating }) => {
        const getRatingColor = (r) => {
          if (r === 'Ready for Review') return 'bg-green-100 text-green-800 border-green-200';
          if (r === 'Needs Minor Polish') return 'bg-yellow-100 text-yellow-800 border-yellow-200';
          return 'bg-red-100 text-red-800 border-red-200';
        };

        // Calculate score based on 5 boolean criteria + word count check
        const criteria = [
          scorecard.conversationalTone,
          scorecard.scannability,
          scorecard.creativeFormatting,
          scorecard.packaging,
          scorecard.adminCheck,
          scorecard.wordCount <= 750
        ];
        const metCount = criteria.filter(Boolean).length;
        const percentage = Math.round((metCount / criteria.length) * 100);

        return (
          <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div className="bg-blue-600 px-6 py-4"><h3 className="text-white font-bold">Section 1: The Pulse Readiness Scorecard</h3></div>
            <div className="p-6 space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="flex items-center"><CheckIcon checked={scorecard.conversationalTone}/><span className="text-sm">Conversational Tone</span></div>
                <div className="flex items-center"><CheckIcon checked={scorecard.scannability}/><span className="text-sm">Scannability</span></div>
                <div className="flex items-center"><CheckIcon checked={scorecard.creativeFormatting}/><span className="text-sm">Creative Formatting</span></div>
                <div className="flex items-center"><CheckIcon checked={scorecard.packaging}/><span className="text-sm">Packaging</span></div>
                <div className="flex items-center"><CheckIcon checked={scorecard.adminCheck}/><span className="text-sm">Admin Check</span></div>
                <div className="flex items-center text-sm font-medium">Word Count: {scorecard.wordCount} / 750</div>
              </div>
              <div className="mt-4 pt-4 border-t space-y-3">
                <div className="flex items-center justify-between">
                  <span className="font-bold text-gray-700">Rating:</span>
                  <span className={`px-3 py-1 rounded-full text-xs font-bold border ${getRatingColor(rating)}`}>{rating}</span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="font-bold text-gray-700">Readiness Score:</span>
                  <div className="flex items-center gap-3">
                    <div className="w-24 bg-gray-200 rounded-full h-2">
                      <div className="bg-blue-600 h-2 rounded-full transition-all duration-1000" style={{ width: `${percentage}%` }}></div>
                    </div>
                    <span className="text-lg font-black text-blue-600">{percentage}%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // --- Main App ---
      const App = () => {
        const [state, setState] = useState({ draft: '', evaluation: null, isLoading: false, error: null });
        const [apiKey, setApiKey] = useState(localStorage.getItem('AOTA_API_KEY') || '');
        const [showSettings, setShowSettings] = useState(false);
        const [googleLink, setGoogleLink] = useState('');
        const fileRef = useRef(null);

        const handleEvaluate = async () => {
          if (!apiKey) { setShowSettings(true); return; }
          setState(s => ({ ...s, isLoading: true, error: null }));
          const ai = new GoogleGenAI({ apiKey });
          try {
            const response = await ai.models.generateContent({
              model: "gemini-3-pro-preview",
              contents: `Evaluate: ${googleLink ? 'Link: ' + googleLink : ''} Content: ${state.draft}`,
              config: {
                systemInstruction: SYSTEM_INSTRUCTION,
                responseMimeType: "application/json",
                responseSchema: {
                  type: Type.OBJECT,
                  properties: {
                    scorecard: {
                      type: Type.OBJECT,
                      properties: {
                        conversationalTone: { type: Type.BOOLEAN },
                        scannability: { type: Type.BOOLEAN },
                        creativeFormatting: { type: Type.BOOLEAN },
                        wordCount: { type: Type.INTEGER },
                        packaging: { type: Type.BOOLEAN },
                        adminCheck: { type: Type.BOOLEAN }
                      },
                      required: ["conversationalTone", "scannability", "creativeFormatting", "wordCount", "packaging", "adminCheck"]
                    },
                    readinessRating: { type: Type.STRING },
                    editorNotes: { type: Type.ARRAY, items: { type: Type.STRING } },
                    polishedDraft: { type: Type.STRING }
                  },
                  required: ["scorecard", "readinessRating", "editorNotes", "polishedDraft"]
                }
              }
            });
            setState(s => ({ ...s, evaluation: JSON.parse(response.text), isLoading: false }));
            localStorage.setItem('AOTA_API_KEY', apiKey);
          } catch (err) { setState(s => ({ ...s, error: err.message, isLoading: false })); }
        };

        const onFile = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          try {
            let text = "";
            if (file.type.includes("word")) {
              const res = await window.mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() });
              text = res.value;
            } else if (file.type.includes("pdf")) {
              const pdf = await window.pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(it => it.str).join(' ') + "\n";
              }
            } else { text = await file.text(); }
            setState(s => ({ ...s, draft: text }));
          } catch (err) { alert(err.message); }
        };

        return (
          <div className="max-w-6xl mx-auto px-4 py-12">
            {showSettings && (
              <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                <div className="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl">
                  <h3 className="text-xl font-bold mb-4">API Configuration</h3>
                  <p className="text-xs text-gray-500 mb-4">Your key is stored locally and never sent to our servers.</p>
                  <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="Gemini API Key" className="w-full p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none" />
                  <button onClick={() => setShowSettings(false)} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors">Save & Close</button>
                </div>
              </div>
            )}

            <header className="mb-12 text-center relative">
              <button onClick={() => setShowSettings(true)} className="absolute right-0 top-0 text-gray-400 hover:text-blue-600 transition-colors"><i className="fas fa-cog text-xl"></i></button>
              <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600"><i className="fas fa-hands-holding text-3xl"></i></div>
              <h1 className="text-4xl font-black text-gray-900">Student Pulse Editor</h1>
              <p className="text-gray-500 mt-2 italic">Mentorship Tool for AOTA Student Contributors</p>
            </header>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div className="space-y-4">
                <div className="bg-white p-6 rounded-xl border shadow-sm">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="font-bold text-gray-700">Article Draft</h2>
                    <button onClick={() => fileRef.current.click()} className="text-xs text-blue-600 font-bold hover:underline flex items-center">
                      <i className="fas fa-file-upload mr-1"></i> Upload doc/pdf
                    </button>
                    <input type="file" ref={fileRef} hidden onChange={onFile} />
                  </div>
                  <div className="relative mb-3">
                    <i className="fas fa-link absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                    <input value={googleLink} onChange={e => setGoogleLink(e.target.value)} placeholder="Paste Google Doc Link (Optional)" className="w-full pl-8 pr-3 py-2 text-sm border rounded bg-gray-50 focus:bg-white outline-none focus:ring-1 focus:ring-blue-500" />
                  </div>
                  <textarea value={state.draft} onChange={e => setState(s => ({ ...s, draft: e.target.value }))} className="w-full h-96 p-4 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500 transition-all font-serif text-lg leading-relaxed" placeholder="Paste your article text here..." />
                  <button onClick={handleEvaluate} disabled={state.isLoading} className="w-full mt-4 py-4 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md transform active:scale-[0.98] transition-all disabled:bg-gray-400 disabled:scale-100 flex items-center justify-center gap-2">
                    {state.isLoading ? (
                      <><i className="fas fa-spinner fa-spin"></i> Mentoring...</>
                    ) : (
                      <><i className="fas fa-magic"></i> Evaluate & Mentor</>
                    )}
                  </button>
                  {state.error && <p className="mt-2 text-red-500 text-xs text-center"><i className="fas fa-exclamation-triangle mr-1"></i> {state.error}</p>}
                </div>
              </div>

              <div className="space-y-6">
                {state.evaluation ? (
                  <>
                    <Scorecard scorecard={state.evaluation.scorecard} rating={state.evaluation.readinessRating} />
                    <div className="bg-amber-50 border-l-4 border-amber-500 p-6 rounded-r-xl shadow-sm">
                      <h3 className="font-bold text-amber-900 mb-3 flex items-center gap-2">
                        <i className="fas fa-lightbulb"></i> Section 2: Editor's Notes
                      </h3>
                      <ul className="space-y-3">
                        {state.evaluation.editorNotes.map((n, i) => (
                          <li key={i} className="text-sm text-amber-800 flex gap-3 leading-relaxed">
                            <span className="font-bold bg-amber-200/50 w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 text-[10px]">{i+1}</span>
                            {n}
                          </li>
                        ))}
                      </ul>
                    </div>
                    <div className="bg-white border rounded-xl overflow-hidden shadow-sm">
                      <div className="bg-indigo-600 p-4 text-white font-bold flex justify-between items-center">
                        <span>Section 3: Polished Draft</span>
                        <button onClick={() => {
                          navigator.clipboard.writeText(state.evaluation.polishedDraft);
                          alert("Draft copied to clipboard!");
                        }} className="text-[10px] uppercase bg-white/20 hover:bg-white/30 px-2 py-1 rounded">Copy Text</button>
                      </div>
                      <div className="p-8 text-gray-800 whitespace-pre-wrap leading-loose font-serif text-lg bg-gray-50/30">
                        {state.evaluation.polishedDraft.split('**').map((part, i) => i % 2 === 1 ? <strong key={i} className="text-blue-700 bg-blue-50 px-1 rounded border-b border-blue-200">{part}</strong> : part)}
                      </div>
                    </div>
                  </>
                ) : (
                  <div className="h-full min-h-[400px] flex flex-col items-center justify-center p-12 border-2 border-dashed rounded-xl text-gray-400 bg-white/50">
                    <div className="mb-4 text-6xl opacity-10"><i className="fas fa-file-signature"></i></div>
                    <p className="text-lg font-medium">Ready to review your work?</p>
                    <p className="text-sm">Submit your draft on the left to see the scorecard.</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
