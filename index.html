
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AOTA Student Pulse Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for browser-side TSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@1.3.0",
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>
    
    <script>
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- App Logic -->
    <script type="text/babel" data-type="module">
      import { GoogleGenAI, Type } from "@google/genai";
      const { useState, useEffect, useRef } = React;

      // --- Constants ---
      const SYSTEM_INSTRUCTION = `
        You are the Senior Editor for the American Occupational Therapy Association (AOTA) "Student Pulse" e-newsletter. 
        Your goal is to mentor OT and OTA students to refine their articles for publication.
        Evaluate the draft against:
        1. Tone: Authentic, conversational, peer-to-peer.
        2. Format: Bulleted/numbered lists, headings, no walls of text.
        3. Structure: Strong thesis, supporting points.
        4. Packaging: Catchy title.
        5. Length: Max 750 words.
        6. Admin: Must have signed copyright form.

        Disclaimer: "Please note: Articles are not guaranteed to be published based on a pitch or a first draft."

        Output JSON. Bold edits with **text**. Use person-first language.
      `;

      // --- Components ---
      const CheckIcon = ({ checked }) => (
        <span className={`mr-2 flex-shrink-0 w-6 h-6 flex items-center justify-center rounded border ${checked ? 'bg-green-100 border-green-500 text-green-700' : 'bg-gray-100 border-gray-300 text-gray-400'}`}>
          {checked ? <i className="fas fa-check text-xs"></i> : <i className="fas fa-times text-xs"></i>}
        </span>
      );

      const Scorecard = ({ scorecard, rating }) => {
        const getRatingColor = (r) => {
          if (r === 'Ready for Review') return 'bg-green-100 text-green-800 border-green-200';
          if (r === 'Needs Minor Polish') return 'bg-yellow-100 text-yellow-800 border-yellow-200';
          return 'bg-red-100 text-red-800 border-red-200';
        };

        const criteriaMet = [
          scorecard.conversationalTone,
          scorecard.scannability,
          scorecard.creativeFormatting,
          scorecard.packaging,
          scorecard.adminCheck,
          scorecard.wordCount <= 750
        ].filter(Boolean).length;
        
        const percentage = Math.round((criteriaMet / 6) * 100);

        return (
          <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div className="bg-blue-600 px-6 py-4">
              <h3 className="text-white font-bold">Section 1: The Pulse Readiness Scorecard</h3>
            </div>
            <div className="p-6 space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="flex items-center"><CheckIcon checked={scorecard.conversationalTone}/><span className="text-sm text-gray-600">Conversational Tone</span></div>
                <div className="flex items-center"><CheckIcon checked={scorecard.scannability}/><span className="text-sm text-gray-600">Scannability</span></div>
                <div className="flex items-center"><CheckIcon checked={scorecard.creativeFormatting}/><span className="text-sm text-gray-600">Creative Formatting</span></div>
                <div className="flex items-center"><CheckIcon checked={scorecard.packaging}/><span className="text-sm text-gray-600">Packaging</span></div>
                <div className="flex items-center"><CheckIcon checked={scorecard.adminCheck}/><span className="text-sm text-gray-600">Admin Check</span></div>
                <div className="flex items-center">
                   <span className={`mr-2 w-6 h-6 flex items-center justify-center rounded border ${scorecard.wordCount <= 750 ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-red-50 border-red-200 text-red-600'}`}>
                      <i className="fas fa-calculator text-[10px]"></i>
                   </span>
                   <span className="text-sm text-gray-600">Word Count: {scorecard.wordCount} / 750</span>
                </div>
              </div>

              <div className="mt-4 pt-6 border-t border-gray-100 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div className="flex flex-col gap-1">
                  <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">Overall Rating</span>
                  <div className="flex items-center gap-3">
                    <span className={`px-4 py-1.5 rounded-full text-sm font-bold border shadow-sm ${getRatingColor(rating)}`}>
                      {rating}
                    </span>
                  </div>
                </div>
                
                <div className="flex items-center gap-4 bg-gray-50 px-4 py-2 rounded-lg border border-gray-100">
                  <div className="text-right">
                    <span className="block text-[10px] font-bold text-gray-400 uppercase">Author Score</span>
                    <span className="text-2xl font-black text-blue-600 leading-none">{percentage}%</span>
                  </div>
                  <div className="w-12 h-12 rounded-full border-4 border-gray-200 relative flex items-center justify-center">
                    <svg className="absolute inset-0 w-full h-full -rotate-90">
                      <circle 
                        cx="24" cy="24" r="20" 
                        fill="transparent" 
                        stroke="currentColor" 
                        strokeWidth="4" 
                        className="text-blue-500"
                        strokeDasharray={125.6}
                        strokeDashoffset={125.6 - (125.6 * percentage) / 100}
                        strokeLinecap="round"
                      />
                    </svg>
                    <i className="fas fa-star text-blue-200 text-xs"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // --- Main App ---
      const App = () => {
        const [state, setState] = useState({ draft: '', evaluation: null, isLoading: false, error: null });
        const [apiKey, setApiKey] = useState(localStorage.getItem('AOTA_API_KEY') || '');
        const [showSettings, setShowSettings] = useState(false);
        const [googleLink, setGoogleLink] = useState('');
        const fileRef = useRef(null);

        const handleEvaluate = async () => {
          if (!apiKey) { setShowSettings(true); return; }
          setState(s => ({ ...s, isLoading: true, error: null }));
          const ai = new GoogleGenAI({ apiKey });
          try {
            const response = await ai.models.generateContent({
              model: "gemini-3-pro-preview",
              contents: `Evaluate this article: ${googleLink ? 'Link: ' + googleLink : ''} \n\n Content: ${state.draft}`,
              config: {
                systemInstruction: SYSTEM_INSTRUCTION,
                responseMimeType: "application/json",
                responseSchema: {
                  type: Type.OBJECT,
                  properties: {
                    scorecard: {
                      type: Type.OBJECT,
                      properties: {
                        conversationalTone: { type: Type.BOOLEAN },
                        scannability: { type: Type.BOOLEAN },
                        creativeFormatting: { type: Type.BOOLEAN },
                        wordCount: { type: Type.INTEGER },
                        packaging: { type: Type.BOOLEAN },
                        adminCheck: { type: Type.BOOLEAN }
                      },
                      required: ["conversationalTone", "scannability", "creativeFormatting", "wordCount", "packaging", "adminCheck"]
                    },
                    readinessRating: { type: Type.STRING },
                    editorNotes: { type: Type.ARRAY, items: { type: Type.STRING } },
                    polishedDraft: { type: Type.STRING }
                  },
                  required: ["scorecard", "readinessRating", "editorNotes", "polishedDraft"]
                }
              }
            });
            setState(s => ({ ...s, evaluation: JSON.parse(response.text), isLoading: false }));
            localStorage.setItem('AOTA_API_KEY', apiKey);
          } catch (err) { setState(s => ({ ...s, error: err.message, isLoading: false })); }
        };

        const onFile = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          try {
            let text = "";
            if (file.type.includes("word")) {
              const res = await window.mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() });
              text = res.value;
            } else if (file.type.includes("pdf")) {
              const pdf = await window.pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(it => it.str).join(' ') + "\n";
              }
            } else { text = await file.text(); }
            setState(s => ({ ...s, draft: text }));
          } catch (err) { alert(err.message); }
        };

        const copyDraft = () => {
            if (!state.draft) return;
            navigator.clipboard.writeText(state.draft);
            alert("Draft copied to clipboard!");
        };

        return (
          <div className="max-w-6xl mx-auto px-4 py-12">
            {showSettings && (
              <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                <div className="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl">
                  <h3 className="text-xl font-bold mb-4">Settings</h3>
                  <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="Gemini API Key" className="w-full p-3 border rounded-lg mb-4" />
                  <button onClick={() => setShowSettings(false)} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold">Save & Close</button>
                </div>
              </div>
            )}

            <header className="mb-12 text-center relative">
              <button onClick={() => setShowSettings(true)} className="absolute right-0 top-0 text-gray-400 hover:text-blue-600"><i className="fas fa-cog text-xl"></i></button>
              <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 shadow-sm"><i className="fas fa-hands-holding text-3xl"></i></div>
              <h1 className="text-4xl font-black text-gray-900">Student Pulse Editor</h1>
              <p className="text-gray-500 mt-2 italic">Mentorship Tool for AOTA Student Contributors</p>
            </header>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div className="space-y-4">
                <div className="bg-white p-6 rounded-xl border shadow-sm">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="font-bold text-gray-700">Article Draft</h2>
                    <div className="flex gap-4">
                        <button onClick={copyDraft} className="text-xs text-gray-500 font-bold hover:text-blue-600 flex items-center">
                          <i className="fas fa-copy mr-1"></i> Copy Draft
                        </button>
                        <button onClick={() => fileRef.current.click()} className="text-xs text-blue-600 font-bold hover:underline">
                          <i className="fas fa-file-upload mr-1"></i> Upload doc/pdf
                        </button>
                    </div>
                    <input type="file" ref={fileRef} hidden onChange={onFile} />
                  </div>
                  <input value={googleLink} onChange={e => setGoogleLink(e.target.value)} placeholder="Paste Google Doc Link (Optional)" className="w-full p-2 text-sm border rounded mb-3 bg-gray-50 focus:bg-white outline-none" />
                  <textarea value={state.draft} onChange={e => setState(s => ({ ...s, draft: e.target.value }))} className="w-full h-[450px] p-4 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500 font-serif text-lg leading-relaxed" placeholder="Paste your article text here..." />
                  <button onClick={handleEvaluate} disabled={state.isLoading} className="w-full mt-4 py-4 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors disabled:bg-gray-400 flex items-center justify-center gap-2">
                    {state.isLoading ? <><i className="fas fa-spinner fa-spin"></i> Mentoring...</> : "Evaluate Draft"}
                  </button>
                  {state.error && <p className="mt-2 text-red-500 text-xs text-center">{state.error}</p>}
                </div>
              </div>

              <div className="space-y-6">
                {state.evaluation ? (
                  <>
                    <Scorecard scorecard={state.evaluation.scorecard} rating={state.evaluation.readinessRating} />
                    <div className="bg-amber-50 border-l-4 border-amber-500 p-6 rounded-r-xl shadow-sm">
                      <h3 className="font-bold text-amber-900 mb-3 flex items-center gap-2"><i className="fas fa-lightbulb"></i> Editor's Notes</h3>
                      <ul className="space-y-3">
                        {state.evaluation.editorNotes.map((n, i) => <li key={i} className="text-sm text-amber-800 flex gap-2"><span>â€¢</span>{n}</li>)}
                      </ul>
                    </div>
                    <div className="bg-white border rounded-xl overflow-hidden shadow-sm">
                      <div className="bg-indigo-600 p-4 text-white font-bold flex justify-between items-center">
                        <span>Polished Draft</span>
                        <button onClick={() => { navigator.clipboard.writeText(state.evaluation.polishedDraft); alert("Copied!"); }} className="text-xs bg-white/20 px-2 py-1 rounded">Copy</button>
                      </div>
                      <div className="p-8 text-gray-800 whitespace-pre-wrap leading-relaxed font-serif text-lg">
                        {state.evaluation.polishedDraft.split('**').map((part, i) => i % 2 === 1 ? <strong key={i} className="text-blue-700 bg-blue-50 px-1">{part}</strong> : part)}
                      </div>
                    </div>
                  </>
                ) : (
                  <div className="h-full min-h-[400px] flex flex-col items-center justify-center p-12 border-2 border-dashed rounded-xl text-gray-400 bg-white/50">
                    <i className="fas fa-file-signature text-4xl mb-4 opacity-20"></i>
                    <p className="text-center">Submit your draft to receive a readiness scorecard and editor notes.</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
